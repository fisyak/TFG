#include "TMinuit.h"
#include "TCanvas.h"
#include "TH1.h"
#include "TGraph.h"
#include "TGraphErrors.h"
#include "TMath.h"
#include "TLegend.h"
#include "Names.h"
TCanvas *c1 = 0;
struct dEdxPoint_t {
  Char_t  *name;
  Int_t    type;
  Int_t    bin;
  Int_t    NPoint;
  Double_t x;
  Double_t p;
  Double_t z; // correction wrt Manuel
  Double_t y;
  Double_t dy;
  Double_t chisq;
};
Double_t ParsFit[8] = {
   7.25410e-01, //     1  Scale       
   1.56806e-06, //     2  Tmin        
   4.61027e-07, //     3  TminE       
  -2.78686e-07, //     4  A0          
   5.04261e-02, //     5  B1          
  -2.43081e+00, //     6  D0          
  -9.12143e+00, //     7  D1          
  -1.14640e+00  //     8  D2          
};
//#define  NOELECTRONS
//#include "fitPars0.h"
//#include "fitPars2.h"
//#include "FitPars3.h"
//#include "FitParsG.h"
//#include "FitParsGGG.h"
//#include "FitParsG5.h"
//#include "FitPars122.h"
#include "FitParsP01hi.h"
const Int_t N = sizeof(dEdxZ)/sizeof(dEdxPoint_t);
//________________________________________________________________________________
Double_t Girrf(Double_t poverm, Int_t k = 0, Double_t Tmin=1.e-3) {
  //        returns value of relative ionisation normalised to value
  //        at p/m=4 poverm    p/m (=beta gamma)             (input)
  //        k = 0 (default) pi+/-,K+/-,P/pbar, deuteron, ..
  //        k != 0   e+-
  const Int_t NPart = 2;
  const Int_t NTmin = 7;
  const Int_t Nbg   = 51;
  Double_t si[NPart][NTmin][Nbg] = {
    {
{// PROTON Tmin = 1.e-8 GeV
   0.101943,   0.131933,   0.164116,   0.193259,   0.216897,
   0.235737,   0.250576,   0.261979,   0.270347,   0.276080,
   0.281042,   0.286340,   0.290173,   0.295568,   0.300482,
   0.306566,   0.312465,   0.318372,   0.324223,   0.329744,
   0.335023,   0.340058,   0.344848,   0.349393,   0.353700,
   0.357779,   0.361643,   0.365304,   0.368776,   0.372072,
   0.374913,   0.376389,   0.376593,   0.375846,   0.374266,
   0.371957,   0.369016,   0.365532,   0.361584,   0.357247,
   0.352590,   0.347674,   0.342559,   0.337297,   0.331938,
   0.326529,   0.321112,   0.315727,   0.310410,   0.305197,
   0.300120 },
{// PROTON Tmin = 1.e-7 GeV
   0.347994,   0.357454,   0.371919,   0.385717,   0.395994,
   0.403121,   0.407599,   0.409719,   0.409620,   0.407459,
   0.405736,   0.405501,   0.403439,   0.404088,   0.404118,
   0.406217,   0.408238,   0.410514,   0.413032,   0.415505,
   0.417925,   0.420282,   0.422560,   0.424747,   0.426835,
   0.428824,   0.430713,   0.432507,   0.434210,   0.435828,
   0.437075,   0.437035,   0.435794,   0.433671,   0.430777,
   0.427212,   0.423070,   0.418436,   0.413386,   0.407992,
   0.402319,   0.396428,   0.390375,   0.384211,   0.377984,
   0.371738,   0.365513,   0.359349,   0.353280,   0.347341,
   0.341561 },
{// PROTON Tmin = 1.e-6 GeV
   0.593960,   0.582899,   0.579653,   0.578112,   0.575033,
   0.570452,   0.564575,   0.557418,   0.548858,   0.538810,
   0.530407,   0.524646,   0.516695,   0.512600,   0.507748,
   0.505866,   0.504008,   0.502654,   0.501840,   0.501266,
   0.500827,   0.500505,   0.500272,   0.500101,   0.499971,
   0.499868,   0.499783,   0.499710,   0.499644,   0.499584,
   0.499237,   0.497681,   0.494996,   0.491496,   0.487287,
   0.482467,   0.477124,   0.471339,   0.465187,   0.458736,
   0.452049,   0.445183,   0.438192,   0.431126,   0.424030,
   0.416946,   0.409914,   0.402971,   0.396151,   0.389484,
   0.383002 },
{// PROTON Tmin = 1.e-5 GeV
   0.833507,   0.807579,   0.786688,   0.769868,   0.753491,
   0.737259,   0.721083,   0.704710,   0.687752,   0.669883,
   0.654863,   0.643630,   0.629838,   0.621036,   0.611330,
   0.605482,   0.599758,   0.594782,   0.590641,   0.587023,
   0.583726,   0.580727,   0.577983,   0.575454,   0.573106,
   0.570912,   0.568853,   0.566912,   0.565078,   0.563340,
   0.561399,   0.558327,   0.554198,   0.549321,   0.543798,
   0.537722,   0.531178,   0.524243,   0.516989,   0.509480,
   0.501778,   0.493937,   0.486009,   0.478040,   0.470076,
   0.462155,   0.454316,   0.446594,   0.439021,   0.431628,
   0.424443 },
{// PROTON Tmin = 1.e-4 GeV
   0.839440,   0.852428,   0.868749,   0.883187,   0.893099,
   0.894966,   0.872911,   0.847920,   0.823201,   0.798172,
   0.777163,   0.761008,   0.741863,   0.728709,   0.714420,
   0.704779,   0.695307,   0.686786,   0.679366,   0.672732,
   0.666596,   0.660931,   0.655683,   0.650801,   0.646237,
   0.641954,   0.637921,   0.634114,   0.630511,   0.627096,
   0.623560,   0.618972,   0.613400,   0.607146,   0.600309,
   0.592977,   0.585231,   0.577147,   0.568790,   0.560225,
   0.551508,   0.542692,   0.533826,   0.524955,   0.516121,
   0.507363,   0.498717,   0.490216,   0.481891,   0.473772,
   0.465884 },
{// PROTON Tmin = 1.e-3 GeV
   0.839440,   0.852428,   0.868749,   0.883187,   0.893099,
   0.898899,   0.900993,   0.899481,   0.894283,   0.885457,
   0.877116,   0.862326,   0.842699,   0.828748,   0.812605,
   0.800885,   0.788845,   0.777552,   0.767334,   0.757968,
   0.749173,   0.740953,   0.733272,   0.726078,   0.719325,
   0.712969,   0.706973,   0.701306,   0.695938,   0.690847,
   0.685720,   0.679616,   0.672600,   0.664970,   0.656819,
   0.648232,   0.639285,   0.630050,   0.620592,   0.610969,
   0.601237,   0.591446,   0.581643,   0.571870,   0.562167,
   0.552572,   0.543118,   0.533838,   0.524761,   0.515915,
   0.507326 },
{// PROTON Tmin = 1.e1 GeV
   0.839440,   0.852428,   0.868749,   0.883187,   0.893099,
   0.898899,   0.900993,   0.899481,   0.894283,   0.885457,
   0.878268,   0.874738,   0.867393,   0.866105,   0.863513,
   0.865548,   0.867478,   0.870049,   0.873256,   0.876516,
   0.879759,   0.882956,   0.886067,   0.889055,   0.891893,
   0.894564,   0.897060,   0.899372,   0.901496,   0.903427,
   0.904867,   0.904887,   0.903560,   0.901187,   0.897863,
   0.893675,   0.888699,   0.883011,   0.876680,   0.869776,
   0.862371,   0.854537,   0.846347,   0.837877,   0.829201,
   0.820390,   0.811514,   0.802638,   0.793821,   0.785117,
   0.776576 }},
{
{// ELECTRON Tmin = 1.e-8 GeV
   0.061287,   0.087795,   0.126397,   0.181703,   0.202595,
   0.220138,   0.234761,   0.246683,   0.256100,   0.263201,
   0.268300,   0.272757,   0.278553,   0.283217,   0.289664,
   0.295870,   0.302224,   0.308683,   0.314918,   0.320935,
   0.326709,   0.332211,   0.337422,   0.342334,   0.346949,
   0.351274,   0.355322,   0.359110,   0.362619,   0.365927,
   0.369046,   0.371274,   0.372309,   0.372300,   0.371368,
   0.369625,   0.367170,   0.364099,   0.360497,   0.356446,
   0.352020,   0.347288,   0.342316,   0.337162,   0.331881,
   0.326526,   0.321143,   0.315777,   0.310469,   0.305257,
   0.300178 },
{// ELECTRON Tmin = 1.e-7 GeV
   0.125786,   0.180191,   0.259418,   0.372493,   0.379818,
   0.385913,   0.390665,   0.393878,   0.395446,   0.395244,
   0.393315,   0.391397,   0.392162,   0.391340,   0.393547,
   0.395422,   0.397651,   0.400503,   0.403317,   0.406129,
   0.408914,   0.411632,   0.414253,   0.416758,   0.419139,
   0.421530,   0.423843,   0.426048,   0.428093,   0.430022,
   0.431810,   0.432729,   0.432457,   0.431133,   0.428882,
   0.425818,   0.422050,   0.417685,   0.412824,   0.407566,
   0.401998,   0.396197,   0.390223,   0.384127,   0.377956,
   0.371751,   0.365554,   0.359406,   0.353343,   0.347404,
   0.341621 },
{// ELECTRON Tmin = 1.e-6 GeV
   0.188065,   0.269407,   0.387860,   0.556745,   0.553215,
   0.549427,   0.545222,   0.540270,   0.534318,   0.527012,
   0.518178,   0.509957,   0.505733,   0.499451,   0.497444,
   0.495072,   0.493300,   0.492673,   0.492196,   0.491928,
   0.491837,   0.491870,   0.491977,   0.492123,   0.492286,
   0.492451,   0.492611,   0.492762,   0.492848,   0.492941,
   0.493006,   0.492318,   0.490554,   0.487856,   0.484391,
   0.480299,   0.475593,   0.470347,   0.464633,   0.458521,
   0.452078,   0.445373,   0.438474,   0.431444,   0.424347,
   0.417240,   0.410176,   0.403202,   0.396356,   0.389668,
   0.383168 },
{// ELECTRON Tmin = 1.e-5 GeV
   0.225341,   0.322804,   0.464735,   0.667397,   0.688362,
   0.693097,   0.686526,   0.678489,   0.668279,   0.655910,
   0.641449,   0.627702,   0.618939,   0.607496,   0.601436,
   0.594923,   0.589212,   0.585138,   0.581386,   0.578045,
   0.575080,   0.572423,   0.570010,   0.567790,   0.565726,
   0.563791,   0.561968,   0.560244,   0.558563,   0.556967,
   0.555428,   0.553212,   0.549991,   0.545900,   0.541051,
   0.535547,   0.529485,   0.522951,   0.516028,   0.508790,
   0.501306,   0.493641,   0.485852,   0.477989,   0.470100,
   0.462227,   0.454414,   0.446703,   0.439133,   0.431741,
   0.424562 },
{// ELECTRON Tmin = 1.e-4 GeV
   0.225341,   0.322804,   0.464735,   0.667399,   0.688502,
   0.707020,   0.722967,   0.736155,   0.746477,   0.753312,
   0.754001,   0.738000,   0.728293,   0.714387,   0.705829,
   0.696189,   0.687171,   0.679993,   0.673170,   0.666869,
   0.661084,   0.655754,   0.650813,   0.646201,   0.641872,
   0.637792,   0.633933,   0.630274,   0.626755,   0.623409,
   0.620202,   0.616395,   0.611656,   0.606113,   0.599875,
   0.593041,   0.585702,   0.577942,   0.569838,   0.561459,
   0.552871,   0.544134,   0.535304,   0.526432,   0.517565,
   0.508750,   0.500027,   0.491434,   0.483015,   0.474795,
   0.466821 },
{// ELECTRON Tmin = 1.e-3 GeV
   0.225341,   0.322804,   0.464735,   0.667399,   0.688502,
   0.707020,   0.722967,   0.736155,   0.746477,   0.753660,
   0.757573,   0.761068,   0.768750,   0.772628,   0.781271,
   0.788131,   0.793997,   0.796536,   0.785481,   0.776785,
   0.769068,   0.761861,   0.754986,   0.748371,   0.741985,
   0.735813,   0.729846,   0.724079,   0.718458,   0.713030,
   0.707767,   0.701933,   0.695202,   0.687704,   0.679552,
   0.670848,   0.661690,   0.652161,   0.642342,   0.632307,
   0.622124,   0.611854,   0.601555,   0.591279,   0.581077,
   0.570992,   0.561067,   0.551338,   0.541840,   0.532602,
   0.523648 },
{// ELECTRON Tmin = 1.e1 GeV
   0.225341,   0.322804,   0.464735,   0.667399,   0.688502,
   0.707020,   0.722967,   0.736155,   0.746477,   0.753660,
   0.757573,   0.761068,   0.768750,   0.772628,   0.781271,
   0.788131,   0.793997,   0.799402,   0.803492,   0.806548,
   0.808743,   0.810210,   0.811067,   0.811423,   0.811374,
   0.811006,   0.810387,   0.809573,   0.808541,   0.807405,
   0.806174,   0.804141,   0.801002,   0.796909,   0.791990,
   0.786363,   0.780137,   0.773409,   0.766268,   0.758796,
   0.751070,   0.743158,   0.735125,   0.727027,   0.718920,
   0.710854,   0.702875,   0.695023,   0.687337,   0.679848,
   0.672586 }}
  };
	       
  Double_t beta2inv = 1. + 1./(poverm*poverm);
  Double_t bgL = TMath::Log10 (poverm);
  Double_t  X   = 10*(bgL+1);
  if (X < 0) X = 0;
  if (X > Nbg) X = Nbg;
  Int_t    iX   = (int) X;
  if (iX < 0) iX = 0;
  if (iX > Nbg - 2) iX = Nbg - 2;
  Double_t dX   = X - iX;
  Int_t l = 0;
  if (k != 0) l = 1; // e+/-
  Double_t Y = 8;
  if (Tmin > 0) Y = 8 + TMath::Log10(Tmin);
  if (Y < 0) Y = 0;
  if (Y > 6) Y = 6;
  Int_t iY = (int) Y;
  if (iY < 0) iY = 0;
  if (iY > NTmin-2) iY = NTmin-2;
  Double_t dY = Y - iY;
  Double_t Dx = 1 - dX;
  Double_t Dy = 1 - dY;
  Double_t sirrf =  
    Dx*Dy*si[l][iY][iX]   + dX*Dy*si[l][iY][iX+1] +
    Dx*dY*si[l][iY+1][iX] + dX*dY*si[l][iY+1][iX+1];
  sirrf *=   beta2inv*(bgL + 2.);
#if 0
printf("poverm : %f l : %i iY : %i iX : %i dX = %f dY = %f sirrf = %f Tmin: %f\n",
       poverm,l,iY,iX,dX,dY,sirrf, Tmin);
printf("Dx:%f Dy:%f si[l][iY][iX]:%f\n",Dx,Dy,si[l][iY][iX]);
#endif
  return sirrf;
}
//______________________________________________________________________________
Double_t funG(Double_t *x,Double_t *par)
{
  Double_t poverm = x[0];
  Int_t k = (int) x[1];
  Int_t l = 0;
  if (k == 2 || k == 6) l = 1;
  Double_t Tmin  = par[l+1];
  Double_t dEL   = TMath::Log(1.e-6*Girrf(poverm,l,Tmin));
  Double_t beta2inv = 1. + 1./(poverm*poverm);
  Double_t bL    = TMath::Log(beta2inv);
  dEL           += bL*par[4] + par[5]*TMath::Exp(par[6]*(TMath::Log10(poverm)-par[7]));
  Double_t gL    = TMath::Log10(poverm);
  dEL           += gL*(par[8] + gL*(par[9] + gL*par[10]));
  Double_t dE    = TMath::Exp(dEL);
  Double_t Loss  = par[3];
  Double_t value = par[0] + TMath::Log(Loss+dE);
#if 0
  printf("poverm: %f l:%i Tmin:%f dEL: %f value: %f\n",poverm,l,Tmin,dEL,value);
#endif
  return value;
}
//______________________________________________________________________________
Double_t funGH(Double_t *xx,Double_t *par)
{
  Double_t x[2];
  x[0] = xx[0];
  x[1] = 0;
  return 1.e6*TMath::Exp(funG(x,ParsFit));
}
//______________________________________________________________________________
Double_t funGE(Double_t *xx,Double_t *par)
{
  Double_t x[2];
  x[0] = xx[0];
  x[1] = 2;
  return 1.e6*TMath::Exp(funG(x,ParsFit));
}
//______________________________________________________________________________
Double_t func(Double_t *x,Double_t *par)
{
  Double_t xx[2];
  //  xx[0] = pow(10.,par[3]+par[4]*x[0]);
  Double_t poverm = pow(10.,x[0]);
  xx[0] = poverm;
  xx[1] = x[1];
  Double_t value = funG(xx,par);
  return value;
}
//______________________________________________________________________________
void fcn(Int_t &npar, Double_t *gin, Double_t &f, Double_t *par, Int_t iflag){
  Int_t i;
  
  //calculate chisquare
  Double_t chisq = 0;
  Double_t delta;
  Int_t bad = 0; 
  Double_t worse = 0., badval = 0;
  for (i=0;i<N; i++) {
    Double_t xx[3];
    xx[0]= dEdxZ[i].x;
    //    if (xx[0] < 0) continue;
    //    Double_t val =  func(&xx,par);   
    xx[1] = dEdxZ[i].type;
    xx[2] = dEdxZ[i].bin;
    //    if (dEdxZ[i].dy > 0.02) continue;
    //    if (dEdxZ[i].type == 2 || dEdxZ[i].type == 6) continue;
    Double_t val =  func(xx,par);   
    //    Double_t poverm = pow(10.,xx);
    //    Double_t val = par[0]+TMath::Log(1.e-3*Girrf(poverm,dEdxZ[i].type));
    if (dEdxZ[i].dy <= 0) continue;
    delta  = (dEdxZ[i].y-val)/dEdxZ[i].dy;
    if (iflag == 3) {
      printf ("%i %s bin %i point %i x = %f y = %f +/- %f function  %f delta = %f\n",i,
	      dEdxZ[i].name,dEdxZ[i].bin, dEdxZ[i].NPoint, dEdxZ[i].x,dEdxZ[i].y,dEdxZ[i].dy,val,delta);
      if (dEdxZ[i].dy > 0.03 || dEdxZ[i].dy < 0.0005) 
	printf("=======================================================\n");
      if (TMath::Abs(worse) < TMath::Abs(delta)) {
	worse = delta; bad = i; badval = val;
      }
    }
    chisq += delta*delta;
  }
  if (iflag == 3) {
    printf("The worst bin = %i\n",bad);
    i = bad; delta = worse;
    printf ("%i %s bin %i point %i x = %f y = %f +/- %f function  %f delta = %f\n",i,
	    dEdxZ[i].name, dEdxZ[i].bin, dEdxZ[i].NPoint, dEdxZ[i].x,dEdxZ[i].y,dEdxZ[i].dy,badval,delta);
  }
  f = chisq;
}
//______________________________________________________________________________
void gFit()
{
  TMinuit *gMinuit = new TMinuit(5);  //initialize TMinuit with a maximum of 5 params
  gMinuit->SetFCN(fcn);
  
  Double_t arglist[10];
  Int_t ierflg = 0;
  //   f1->SetParNames("constant","coefficient");
  arglist[0] = 1;
  gMinuit->mnexcm("SET ERR", arglist ,1,ierflg);
  gMinuit->DefineParameter( 0, "Scale"  , 7.25410e-01,  0.01,     0, 0.0);        
  gMinuit->DefineParameter( 1, "Tmin "  , 1.56806e-06,  0.01, 1.e-8, 1.e-3); 
  gMinuit->DefineParameter( 2, "TminE"  , 4.61027e-07,  0.01, 1.e-8, 1.e-2); 
  gMinuit->DefineParameter( 3, "A0   "  ,-2.78686e-07,  0.01,     0, 0.0);  
  gMinuit->DefineParameter( 4, "B1   "  , 5.04261e-02,  0.01,     0, 0.0);  
  gMinuit->DefineParameter( 5, "D0   "  ,-2.43081e+00,  0.01,     0, 0.0);  
  gMinuit->DefineParameter( 6, "D1   "  ,-9.12143e+00,  0.01,     0, 0.0);  
  gMinuit->DefineParameter( 7, "D2   "  ,-1.14640e+00,  0.01,     0, 0.0);  
  gMinuit->DefineParameter( 8, "g1   "  , 0.00000e+00,  0.01,     0, 0.0);  
  gMinuit->DefineParameter( 9, "g2   "  , 0.00000e+00,  0.00,     0, 0.0);  
  gMinuit->DefineParameter(10, "g3   "  , 0.00000e+00,  0.00,     0, 0.0);  
#if 1
  gMinuit->Migrad();
  gMinuit->mnexcm("IMPROVE", arglist ,0,ierflg);
  gMinuit->mnexcm("HESSE", arglist ,0,ierflg);
  gMinuit->mnexcm("end", arglist ,0,ierflg);
  // Print results
  Double_t amin,edm,errdef;
  Int_t nvpar,nparx,icstat;
  gMinuit->mnstat(amin,edm,errdef,nvpar,nparx,icstat);
  gMinuit->mnprin(3,amin);
#endif
  Double_t Z[20],dZ[20];
  if (!c1) c1 = new TCanvas();//,"gerrors2",2,10,700,500);
  c1->SetFillColor(42);
  c1->SetGrid();
  for (int k = 0; k < 20; k++)  gMinuit->GetParameter(k, Z[k], dZ[k]);
  TGraphErrors *gr[10];
  Double_t xmin = 99, xmax = -99, ymin = 99, ymax = -99;
  for (int k = 0; k < 8; k++) {
    gr[k] = new TGraphErrors();
    Int_t nk = 0;
    //    if (k == 2 || k == 6) continue;
    for (int i = 0; i < N; i++) {
      if (k < 8 && dEdxZ[i].type != k) continue;
      Double_t xx[3];
      xx[0] = dEdxZ[i].x;
      xx[1] = dEdxZ[i].type;
      xx[2] = dEdxZ[i].bin;
      Double_t d, ff;
#if 1
      ff  = func(xx,Z);
      d = dEdxZ[i].y - ff;
      //      xx[0] = ff;
#else
      d = dEdxZ[i].y;
#endif
      if (xx[0] < xmin) xmin = xx[0];
      if (xx[0] > xmax) xmax = xx[0];
      if (d     < ymin) ymin = d;
      if (d     > ymax) ymax = d;
      gr[k]->SetPoint(nk,xx[0],d);
      gr[k]->SetPointError(nk,0.,dEdxZ[i].dy);
      nk++;
    }
    //    printf("k: %i nk: %i\n",k,nk);
  }
  printf("x|y min|max %f %f %f %f\n",xmin,ymin,xmax,ymax);
  c1->DrawFrame(xmin-0.01,ymin-0.01,xmax+0.01,ymax+0.01);
  TLegend *leg = new TLegend(0.91,0.11,1.00,0.89,"");//TLegend(0.79,0.91,0.89,0.89,"");
  for (int k = 0; k < 8; k++) {
    if (gr[k]->GetN()>0) {
      Int_t c = k/4 + 1;
      Int_t s = k%4 + 20;
      gr[k]->SetMarkerColor(c);
      gr[k]->SetMarkerStyle(s);
      gr[k]->Draw("P");
      leg->AddEntry(gr[k],Names[k],"p");
    }
  }
  leg->Draw();
}
